# JP Input Guard – Concept

JP Input Guard は「入力中の体験」と「確定時のデータ整合性」を分離することを目的とした入力制御ライブラリです。

単なる入力制限ではなく、以下の思想に基づいて設計されています。

## 基本思想

### 1. 入力中はユーザー体験を優先する

入力中はできる限り:

- キャレット位置を保つ
- IME動作を壊さない
- 強制的な書き換えを最小限にする

過度なリアルタイム補正はUXを損なう可能性があるため、
入力中は `normalizeChar` と `normalizeStructure`、および `validate` に留めます。

### 2. 確定時はデータ整合性を優先する

フォーカスが外れたタイミング（`blur`）で:

- 未完成な値の補正（`fix`）
- 小数丸め
- 先頭ゼロ整理
- 表示整形（`format`）

を行います。

これにより、入力体験とデータ品質を両立させます。

## フェーズ分離設計

JP Input Guard では処理を5つのフェーズに分けています。

1. `normalizeChar`
2. `normalizeStructure`
3. `validate`
4. `fix`（確定時のみ）
5. `format`（確定時のみ）

この分離により、

- 役割の明確化
- ルールの責務分離
- 将来拡張の容易さ

を実現しています。

## エラーと入力ブロックの分離

JP Input Guard では以下を明確に分けています。

### `ctx.pushError()`

- エラーを記録する
- 入力は許可する
- `invalidClass` 制御などに使用

### `ctx.requestRevert()`

- 入力を無効化する
- 直前の受理値へ巻き戻す
- 強制的な入力ブロック

「エラー表示」と「入力拒否」は別概念です。

## raw値と表示値の分離（`swap` モード）

`separateValue.mode = "swap"` の場合、

- raw（`hidden` input）… 送信用データ
- display（`text` input）… 表示用

を分離します。

`format` フェーズは display のみに適用され、  
raw値は常に整形前の値を保持します。

## キャレット保持

入力中に値が `normalizeChar` や `normalizeStructure` によって書き換わる場合でも、
可能な限りキャレット位置を維持します。

正規化は「左側のみ再評価」することで、
自然なカーソル位置を推定します。

## IME対応

- `compositionstart` 中は評価を行わない
- `compositionend` 後に再評価

IME入力を破壊しない設計を採用しています。

## 設計目標

- 入力体験を壊さない
- データ整合性を守る
- ルール責務を明確に分離する
- 将来的な拡張に耐える

JP Input Guard は単なる入力制限ではなく、
「入力フロー設計ライブラリ」です。
