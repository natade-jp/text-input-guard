/*!
 * JP Input Guard
 * AUTHOR: natade (https://github.com/natade-jp/)
 * LICENSE: MIT https://opensource.org/licenses/MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).JPInputGuard={})}(this,function(t){"use strict";function e(t,e){e&&console.warn(t)}class i{constructor(t,e){this.originalElement=t,this.options=e;const i=(s=t)instanceof HTMLInputElement?"input":s instanceof HTMLTextAreaElement?"textarea":null;var s;if(!i)throw new TypeError("[jp-input-guard] attach() expects an <input> or <textarea> element.");this.kind=i,this.warn=e.warn??!0,this.invalidClass=e.invalidClass??"is-invalid",this.rules=Array.isArray(e.rules)?e.rules:[],this.hostElement=t,this.displayElement=t,this.rawElement=null,this.composing=!1,this.errors=[],this.normalizeCharRules=[],this.normalizeStructureRules=[],this.validateRules=[],this.fixRules=[],this.formatRules=[],this.onCompositionStart=this.onCompositionStart.bind(this),this.onCompositionEnd=this.onCompositionEnd.bind(this),this.onInput=this.onInput.bind(this),this.onBlur=this.onBlur.bind(this),this.swapState=null}init(){this.applySeparateValue(),this.buildPipeline(),this.bindEvents(),this.evaluateInput()}applySeparateValue(){if("swap"!==(this.options.separateValue?.mode??"off"))return;if("input"!==this.kind)return void e('[jp-input-guard] separateValue.mode="swap" is not supported for <textarea>. ignored.',this.warn);const t=this.originalElement;this.swapState={originalType:t.type,originalId:t.getAttribute("id"),originalName:t.getAttribute("name"),originalClass:t.className,createdDisplay:null},t.type="hidden",t.removeAttribute("id"),t.dataset.jpigRole="raw";const i=document.createElement("input");i.type="text",i.dataset.jpigRole="display",this.swapState.originalId&&(i.id=this.swapState.originalId),i.removeAttribute("name"),i.className=this.swapState.originalClass,t.className="",i.value=t.value,t.after(i),this.hostElement=t,this.displayElement=i,this.rawElement=t,this.swapState.createdDisplay=i}detach(){if(this.unbindEvents(),!this.swapState)return;const t=this.swapState,e=this.hostElement,i=t.createdDisplay;if(i)try{e.value=e.value||i.value}catch(t){}i&&i.parentNode&&i.parentNode.removeChild(i),e.type=t.originalType,t.originalId?e.setAttribute("id",t.originalId):e.removeAttribute("id"),t.originalName?e.setAttribute("name",t.originalName):e.removeAttribute("name"),e.className=t.originalClass??"",delete e.dataset.jpigRole,this.hostElement=this.originalElement,this.displayElement=this.originalElement,this.rawElement=null,this.swapState=null}buildPipeline(){this.normalizeCharRules=[],this.normalizeStructureRules=[],this.validateRules=[],this.fixRules=[],this.formatRules=[];for(const t of this.rules){"input"===this.kind&&t.targets.includes("input")||"textarea"===this.kind&&t.targets.includes("textarea")?(t.normalizeChar&&this.normalizeCharRules.push(t),t.normalizeStructure&&this.normalizeStructureRules.push(t),t.validate&&this.validateRules.push(t),t.fix&&this.fixRules.push(t),t.format&&this.formatRules.push(t)):e(`[jp-input-guard] Rule "${t.name}" is not supported for <${this.kind}>. skipped.`,this.warn)}}bindEvents(){this.displayElement.addEventListener("compositionstart",this.onCompositionStart),this.displayElement.addEventListener("compositionend",this.onCompositionEnd),this.displayElement.addEventListener("input",this.onInput),this.displayElement.addEventListener("blur",this.onBlur)}unbindEvents(){this.displayElement.removeEventListener("compositionstart",this.onCompositionStart),this.displayElement.removeEventListener("compositionend",this.onCompositionEnd),this.displayElement.removeEventListener("input",this.onInput),this.displayElement.removeEventListener("blur",this.onBlur)}createCtx(){return{hostElement:this.hostElement,displayElement:this.displayElement,rawElement:this.rawElement,kind:this.kind,warn:this.warn,invalidClass:this.invalidClass,composing:this.composing,pushError:t=>this.errors.push(t)}}clearErrors(){this.errors=[]}runNormalizeChar(t){const e=this.createCtx();let i=t;for(const t of this.normalizeCharRules)i=t.normalizeChar?t.normalizeChar(i,e):i;return i}runNormalizeStructure(t){const e=this.createCtx();let i=t;for(const t of this.normalizeStructureRules)i=t.normalizeStructure?t.normalizeStructure(i,e):i;return i}runValidate(t){const e=this.createCtx();for(const i of this.validateRules)i.validate&&i.validate(t,e)}runFix(t){const e=this.createCtx();let i=t;for(const t of this.fixRules)i=t.fix?t.fix(i,e):i;return i}runFormat(t){const e=this.createCtx();let i=t;for(const t of this.formatRules)i=t.format?t.format(i,e):i;return i}applyInvalidClass(){const t=this.displayElement;this.errors.length>0?t.classList.add(this.invalidClass):t.classList.remove(this.invalidClass)}syncRaw(t){this.rawElement&&(this.rawElement.value=t)}syncDisplay(t){(this.displayElement instanceof HTMLInputElement||this.displayElement instanceof HTMLTextAreaElement)&&(this.displayElement.value=t)}onCompositionStart(){this.composing=!0}onCompositionEnd(){this.composing=!1}onInput(){this.evaluateInput()}onBlur(){this.evaluateCommit()}evaluateInput(){if(this.composing)return;this.clearErrors();const t=this.displayElement.value;let e=t;e=this.runNormalizeChar(e),e=this.runNormalizeStructure(e),e!==t&&this.syncDisplay(e),this.runValidate(e),this.syncRaw(e),this.applyInvalidClass()}evaluateCommit(){if(this.composing)return;this.clearErrors();let t=this.displayElement.value;t=this.runNormalizeChar(t),t=this.runNormalizeStructure(t),this.runValidate(t),t=this.runFix(t),t=this.runFormat(t),this.syncDisplay(t),this.syncRaw(t),this.applyInvalidClass()}isValid(){return 0===this.errors.length}getErrors(){return this.errors.slice()}getRawValue(){return this.rawElement?this.rawElement.value:this.displayElement.value}toGuard(){return{detach:()=>this.detach(),isValid:()=>this.isValid(),getErrors:()=>this.getErrors(),getRawValue:()=>this.getRawValue()}}}function s(t={}){const e=t.allowFullWidth??!0,i=t.allowMinus??!1,s=t.allowDecimal??!1,n=new Set(["－","−","‐","-","‒","–","—","―"]),a=new Set(["．","。","｡"]);function r(t){if(t>="0"&&t<="9")return t;if(e){const e=function(t){const e=t.charCodeAt(0);return 65296<=e&&e<=65305?String.fromCharCode(e-65296+48):null}(t);if(e)return e}return"."===t||e&&a.has(t)?s?".":"":"-"===t?i?"-":"":e&&n.has(t)&&i?"-":""}return{name:"numeric",targets:["input"],normalizeChar(t){let e="";for(const i of String(t))e+=r(i);return e},normalizeStructure(t){let e="",n=!1,a=!1;for(const r of String(t))r>="0"&&r<="9"?e+=r:"-"===r&&i?n||0!==e.length||(e+="-",n=!0):"."===r&&s&&(a||(e+=".",a=!0));return e},fix(t){const e=String(t);return"-"===e||"."===e||"-."===e?"":e.endsWith(".")?e.slice(0,-1):e},validate(t,e){}}}const n={numeric:s};t.attach=function(t,e={}){const s=new i(t,e);return s.init(),s.toGuard()},t.numeric=s,t.rules=n,t.version="0.0.1"});
